<style>
    }

    #map {
        height: 900px;
        width: 600px;
        margin: 0 auto;
        border: 5px solid #000;
        border-style: ridge;

    }
</style>
<!-- NOTE: Code changes for the leafletjs settings below this line should not be needed -->
<!-- Change code as needed after the <body> tag -->

<!-- Begin main page content -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="leaflet.wms.js"></script>


<div class='custom-popup' id="map"></div>

<div class="titlebar" style="width:100%; height:5% ">
    <div>
        <h1 id="titlebar"></h1>
    </div>
</div>
<br>

<div align="center">
    <ul class="select" align:"center">
        <li>
            <p>Grid Time: <select class="select" id="time_selector" OnChange="changeNDFD(0.5)"></select></p>
        </li>
        <li>
            <p>Grid Type: <select class="select" id="type" OnChange="changeNDFD(0.5)"></select></p>
        </li>
        <li>
            <p>Region: <select class="select" id="region" OnChange="changeRegion(0.5)"></select></p>
        </li>
    </ul>
</div>

<br>
</div>
<br>
<script>
    function buildMenus() {
        <?php
        $dformat = 'Y-m-d';
        $vd1 = date($dformat);
        $vd2 = date($dformat, strtotime('+1 day'));
        $now = date('H');

        if ($now < 6) {
            $hour = "06:00";
            $start = new DateTime($vd1 . $hour);
        } elseif ($now < 12) {
            $hour = "12:00";
            $start = new DateTime($vd1 . $hour);
        } elseif ($now < 18) {
            $hour = "18:00";
            $start = new DateTime($vd1 . $hour);
        } elseif ($now < 24) {
            $hour = "00:00";
            $start = new DateTime($vd2 . $hour);
        } else {
            echo "Error";
        }


        $interval = new DateInterval('PT6H');
        $period = new DatePeriod($start, $interval, 10);

        $dates = array_map(function ($dt) {
            return $dt->format('Y-m-d H:i');
        }, iterator_to_array($period));

        $i = 0;
        $date_str = array();
        $count = count($dates);

        while ($i < $count) {
            $date_str[] = substr_replace($dates[$i], 'T', 10, 1);
            $i++;
        }
        ?>

        var ndfd_time = <?php echo json_encode($date_str); ?>;
        var vt_array = <?php echo json_encode($dates); ?>;
        //console.log(vt_array);

        var dropdown = $('#region');
        dropdown.empty();
        dropdown.append(('<option value="wa">' + "Western Atlantic" + '</option>'));
        dropdown.append(('<option value="ep">' + "Eastern Pacific" + '</option>'));
        dropdown.append(('<option value="ak">' + "Alaska" + '</option>'));
        dropdown.prop('selectedIndex', 0);

        var dropdown = $('#type');
        dropdown.empty();
        dropdown.append(('<option value="windspd">' + "Wind Speed" + '</option>'));
        dropdown.append(('<option value="windgust">' + "Wind Gusts" + '</option>'));
        dropdown.append(('<option value="waveheight">' + "Wave Height" + '</option>'));
        dropdown.append(('<option value="wwa">' + "Hazards" + '</option>'));

        dropdown.prop('selectedIndex', 0);

        var dropdown = $('#time_selector');
        dropdown.empty()

        for (x = 0; x < vt_array.length; x++) {
            dropdown.append('<option>' + vt_array[x] + '</option>');
        }
        dropdown.prop('selectedIndex', 0);

        return ndfd_time;
    }

    // Set basemap control options
    // add here if we want another option for the background map
    var oceanmap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 13
    });

    const mapDiv = document.getElementById("map");

    // Initialize map
    const map = L.map(mapDiv, {
        center: [45, -65.0],
        zoom: 2,
        //Define the layers we want on by default
        layers: [oceanmap]
    });

    const resizeObserver = new ResizeObserver(() => {
        map.invalidateSize();
    });

    resizeObserver.observe(mapDiv);

    var ndfd = new L.LayerGroup();
    var layers = new L.LayerGroup();

    var opacity = .5;

    layer1 = "";
    layer2 = "";
    layer3 = "";
    wwa_layer = "";
    wwa_points = "";

    function changeRegion() {

        var region_selected = document.getElementById('region');
        r_sel = region_selected.options[region_selected.selectedIndex].value;
        if (map.hasLayer(ndfd) == true) {

            changeNDFD(0.5);
            map_view = document.getElementById('map');

            if (r_sel == "wa") {
                var z = 450 + "px";
                map_view.style.width = z;
                map.setView([40, -75], 5)
            }
            if (r_sel == "ep") {
                var z = 450 + "px";
                map_view.style.width = z;
                map.setView([40, -122], 5);
            }
            if (r_sel == "ak") {
                var z = 600 + "px";
                map_view.style.width = z;
                map.setView([65, -155], 4);
            }
        }
    }

    //##########################################################################################################################

    function loadNDFD(data) {

        var layers = new L.LayerGroup();
        var time_index = document.getElementById('time_selector').selectedIndex;
        var vt = ndfd_time[time_index];
        var typeValue = document.getElementById('type');
        layerType = typeValue.options[typeValue.selectedIndex].value;
        console.log(layerType, time_index);
        console.log(data[0][time_index]);

        if (layerType = "windspd") {

            for (x = 0; x < data[0].length; x++) {
                my_layer = data[0][x]
                //console.log(layer);
                my_layer.addTo(layers);
                my_layer.setOpacity(0.1);
            }
            layers.addTo(map);

            layers.eachLayer(function(layer) {
                console.log(layer);
                //layer.map(function(layer){
                //	layer.setOpacity(0.1);
                //});
            });
        }
    }



    //##########################################################################################################################
    function changeNDFD(opacity) {

        ndfd.clearLayers();

        //#### Get user input fields ###################################################### 
        var time_index = document.getElementById('time_selector').selectedIndex;
        var vt = ndfd_time[time_index];
        console.log("NDFD TIME: " + vt);
        var typeValue = document.getElementById('type');
        layerType = typeValue.options[typeValue.selectedIndex].value;
        console.log("NDFD type : " + layerType);

        var reg = "oceanic"

        //### Set valid time by selected layer ############################################################

        layer1 = "ndfd.oceanic." + layerType;
        layer2 = "ndfd.oceanic." + layerType + ".points";
        layer3 = "ndfd.oceanic." + layerType + ".windbarbs.english";

        var overlays = "'" + layer1 + "," + layer2 + "," + layer3 + "'";
        var overlays2 = "'" + layer1 + "," + layer2 + "'";
        var overlays3 = "'" + layer1 + "'";

        //console.log(overlays2);

        //### Get WMS layer by selected ndfd grid and points if switched on ###############################################

        var ndfd_grid = L.WMS.overlay("https://digital.weather.gov/wms.php", {
            layers: layer1,
            format: "image/png",
            transparent: "true",
            version: "1.3.0",
            vt: vt,
            opacity: opacity
        });
        ndfd_grid.addTo(ndfd);
        //console.log(ndfd_grid)

        var ndfd2_grid = L.WMS.overlay("https://digital.weather.gov/wms.php", {
            layers: layer2,
            format: "image/png",
            transparent: "true",
            version: "1.3.0",
            vt: vt,
            opacity: opacity
        });
        ndfd2_grid.addTo(ndfd);

        if (layerType == "windspd") {
            var ndfd3_grid = L.WMS.overlay("https://digital.weather.gov/wms.php", {
                layers: layer3,
                format: "image/png",
                transparent: "true",
                version: "1.3.0",
                vt: vt,
                opacity: opacity
            });
            ndfd3_grid.addTo(ndfd);
        }

        var state = L.WMS.overlay("https://digital.weather.gov/wms.php", {
            layers: "state",
            format: "image/gif",
            transparent: "true",
            version: "1.3.0",
            vt: vt,
            opacity: opacity
        });
        state.addTo(map);
    }

 

    map.addLayer(ndfd);
    //map.on('overlayadd', changeRegion);


    //Overlay layers, grouped

    var basemaps = {
        "Ocean": oceanmap,
    };

    var groupedOverlays = {
        "Forecasts": {
            "NDFD": ndfd,
            "None": none,
        }
    };
    var layerOptions = {
        // Make the "Map Options" group exclusive (use radio inputs)
        exclusiveGroups: ["Forecasts"],
        // Show a checkbox next to non-exclusive group labels for toggling all
        //groupCheckboxes: true
    };

    //Draw the layer control
    L.control.groupedLayers(basemaps, groupedOverlays, layerOptions).addTo(map);

    //run on page ready
</script>